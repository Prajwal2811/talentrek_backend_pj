CREATE TABLE `talentrek_jobseeker_sessions_booking_payment_request` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  
  -- Reservation Info
  `jobseeker_id` bigint(20) UNSIGNED NOT NULL,
  `user_type` enum('mentor','coach','assessor') NOT NULL,
  `user_id` bigint(20) UNSIGNED NOT NULL,
  `booking_slot_id` bigint(20) UNSIGNED NOT NULL,
  `slot_mode` varchar(191) DEFAULT NULL,
  `slot_date` date NOT NULL,
  `slot_time` varchar(191) NOT NULL,
  `status` enum('awaiting_payment','confirmed','cancelled','expired') NOT NULL DEFAULT 'awaiting_payment',
  `reserved_until` timestamp NULL DEFAULT NULL,

  -- Payment Info
  `amount` decimal(10,2) NOT NULL,
   `tax` decimal(10,2) NOT NULL,
   `total_amount` decimal(10,2) NOT NULL,
  `currency` varchar(10) DEFAULT 'SAR',
  `payment_gateway` varchar(50) DEFAULT 'Al-Rajhi', -- or stripe/paypal/etc.
  `transaction_id` varchar(191) DEFAULT NULL, -- from payment provider
  `payment_status` enum('pending','success','failed','refunded') NOT NULL DEFAULT 'pending',
  `response_payload` json DEFAULT NULL, -- full response from gateway

  -- Timestamps
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE `talentrek_jobseeker_sessions_booking_payment_request`
ADD COLUMN `track_id` varchar(50) NOT NULL UNIQUE COMMENT 'Unique booking reference number'
AFTER `reserved_until`;

ALTER TABLE `talentrek_jobseeker_sessions_booking_payment_request`
ADD COLUMN `request_payload` json DEFAULT NULL COMMENT 'full request sent to gateway'
AFTER `payment_gateway`;

ALTER TABLE `talentrek_jobseeker_saved_booking_session`
ADD COLUMN `track_id` varchar(100) DEFAULT NULL AFTER `booking_slot_id`,
ADD COLUMN `transaction_id` varchar(191) DEFAULT NULL AFTER `track_id`,
ADD COLUMN `payment_status` enum('pending','success','failed','refunded') NOT NULL DEFAULT 'pending' AFTER `transaction_id`,
ADD COLUMN `response_payload` json DEFAULT NULL AFTER `payment_status`;

ALTER TABLE `talentrek_jobseeker_saved_booking_session`
-- New amount columns
ADD COLUMN `amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `response_payload`,
ADD COLUMN `tax` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `amount`,
ADD COLUMN `total_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `tax`;


CREATE TABLE talentrek_purchase_subscriptions_payment_request (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    subscription_plan_id BIGINT UNSIGNED NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL,
    user_type VARCHAR(50) NOT NULL,
    status ENUM('pending', 'active', 'cancelled', 'failed') DEFAULT 'pending',
    track_id VARCHAR(100) NULL,
    amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    tax DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    total_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(10) NOT NULL DEFAULT 'SAR',
    payment_gateway VARCHAR(50) NOT NULL DEFAULT 'Al Rajhi',
    request_payload JSON NULL,
    transaction_id VARCHAR(100) NULL,
    payment_status ENUM('initiated', 'success', 'failed', 'refunded') DEFAULT 'initiated',
    response_payload JSON NULL,
    created_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


ALTER TABLE `talentrek_purchased_subscriptions`
ADD COLUMN `track_id` varchar(100) DEFAULT NULL AFTER `payment_status`,
ADD COLUMN `transaction_id` varchar(191) DEFAULT NULL AFTER `track_id`,
ADD COLUMN `request_payload` json DEFAULT NULL AFTER `payment_status`,
ADD COLUMN `response_payload` json DEFAULT NULL AFTER `payment_status`,
ADD COLUMN `amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `response_payload`,
ADD COLUMN `tax` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `amount`;

CREATE TABLE talentrek_jobseeker_training_material_purchases_payment_request (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    jobseeker_id BIGINT UNSIGNED NOT NULL,
    trainer_id BIGINT UNSIGNED NOT NULL,
    material_id BIGINT UNSIGNED NOT NULL,
    batch_id BIGINT UNSIGNED NULL,
    request_payload JSON NULL,
    track_id VARCHAR(100) NOT NULL UNIQUE, -- unique track/reference ID
    type ENUM('buyNow', 'buyForCorporate', 'cart') NOT NULL,
    training_type VARCHAR(50) NOT NULL, -- e.g., online/classroom/recorded
    transaction_id VARCHAR(100) NULL,
    payment_status ENUM('initiated', 'success', 'failed', 'refunded') DEFAULT 'initiated',
    tax DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,        -- base amount
    amount_paid DECIMAL(10,2) NOT NULL DEFAULT 0.00,   -- actual paid after discount/tax
    currency VARCHAR(10) NOT NULL DEFAULT 'INR',
    payment_gateway VARCHAR(50) NOT NULL,
    created_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_jobseeker (jobseeker_id),
    INDEX idx_trainer (trainer_id),
    INDEX idx_material (material_id),
    INDEX idx_batch (batch_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE `talentrek_jobseeker_training_material_purchases`
ADD COLUMN `track_id` varchar(100) DEFAULT NULL AFTER `transaction_id`,
ADD COLUMN `payment_status` enum('pending','success','failed','refunded') NOT NULL DEFAULT 'pending' AFTER `transaction_id`,
ADD COLUMN `response_payload` json DEFAULT NULL AFTER `payment_status`,
ADD COLUMN `amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `response_payload`,
ADD COLUMN `tax` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `amount`,
ADD COLUMN `total_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `tax`;

ALTER TABLE `talentrek_jobseeker_saved_booking_session`
ADD COLUMN `coupon_type` VARCHAR(50) NULL AFTER `total_amount`,
ADD COLUMN `coupon_code` VARCHAR(100) NULL AFTER `coupon_type`,
ADD COLUMN `coupon_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `coupon_code`,
ADD COLUMN `order_id` VARCHAR(100) NULL AFTER `coupon_amount`;
ALTER TABLE `talentrek_jobseeker_saved_booking_session` 
ADD `tax_amount` DOUBLE(11,2) NULL AFTER `coupon_amount`; 

ALTER TABLE `talentrek_jobseeker_training_material_purchases`
ADD COLUMN `coupon_type` VARCHAR(50) NULL AFTER `total_amount`,
ADD COLUMN `coupon_code` VARCHAR(100) NULL AFTER `coupon_type`,
ADD COLUMN `coupon_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `coupon_code`,
ADD COLUMN `order_id` VARCHAR(100) NULL AFTER `coupon_amount`;

ALTER TABLE `talentrek_purchased_subscriptions`
ADD COLUMN `coupon_type` VARCHAR(50) NULL AFTER `tax`,
ADD COLUMN `coupon_code` VARCHAR(100) NULL AFTER `coupon_type`,
ADD COLUMN `coupon_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 AFTER `coupon_code`,
ADD COLUMN `order_id` VARCHAR(100) NULL AFTER `coupon_amount`;



